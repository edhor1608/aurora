name: README Status Sync

on:
  workflow_dispatch:
  schedule:
    - cron: "17 6 * * *"

jobs:
  sync-readme-status:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync README status block
        shell: bash
        run: |
          set -euo pipefail

          README="README.md"
          STATUS_FILE=".project-status"
          TODAY="$(date -u +%F)"
          START_MARKER='<!-- status:start -->'
          END_MARKER='<!-- status:end -->'

          if [[ ! -f "$README" ]]; then
            echo "README.md not found. Skipping."
            exit 0
          fi

          trim() {
            local s="${1:-}"
            s="${s#${s%%[![:space:]]*}}"
            s="${s%${s##*[![:space:]]}}"
            printf '%s' "$s"
          }

          read_status_value() {
            local key="$1"
            local file="$2"
            local value
            value="$(awk -F'=' -v k="$key" '
              $0 ~ /^[[:space:]]*#/ { next }
              $1 ~ /^[[:space:]]*$/ { next }
              {
                key=$1
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", key)
                if (key == k) {
                  sub(/^[^=]*=/, "", $0)
                  gsub(/^[[:space:]]+|[[:space:]]+$/, "", $0)
                  print $0
                  exit
                }
              }
            ' "$file")"
            trim "$value"
          }

          if [[ ! -f "$STATUS_FILE" ]]; then
            printf 'state=active\nsummary=Define current milestone.\nnext=Define next concrete step.\nupdated=%s\n' "$TODAY" > "$STATUS_FILE"
          fi

          state="$(read_status_value "state" "$STATUS_FILE")"
          summary="$(read_status_value "summary" "$STATUS_FILE")"
          next="$(read_status_value "next" "$STATUS_FILE")"
          updated="$(read_status_value "updated" "$STATUS_FILE")"

          [[ -n "$state" ]] || state="active"
          [[ -n "$summary" ]] || summary="Define current milestone."
          [[ -n "$next" ]] || next="Define next concrete step."
          [[ -n "$updated" ]] || updated="$TODAY"

          block="$(printf '%s\n' \
            "$START_MARKER" \
            "## Status" \
            "- State: $state" \
            "- Summary: $summary" \
            "- Next: $next" \
            "- Updated: $updated" \
            "$END_MARKER")"

          if grep -Fq "$START_MARKER" "$README" && grep -Fq "$END_MARKER" "$README"; then
            inblock=0
            {
              while IFS= read -r line || [[ -n "$line" ]]; do
                if [[ "$inblock" -eq 0 && "$line" == *"$START_MARKER"* ]]; then
                  printf '%s\n' "$block"
                  inblock=1
                  continue
                fi

                if [[ "$inblock" -eq 1 ]]; then
                  if [[ "$line" == *"$END_MARKER"* ]]; then
                    inblock=0
                  fi
                  continue
                fi

                printf '%s\n' "$line"
              done < "$README"
            } > "$README.tmp"
            mv "$README.tmp" "$README"
          else
            printf '\n%s\n' "$block" >> "$README"
          fi

      - name: Detect status drift
        id: drift
        shell: bash
        run: |
          set -euo pipefail

          if git diff --quiet -- README.md .project-status; then
            echo "has_drift=false" >> "$GITHUB_OUTPUT"
            echo "README status already synchronized."
            exit 0
          fi

          echo "has_drift=true" >> "$GITHUB_OUTPUT"
          git diff -- README.md .project-status > readme-status-sync.patch
          echo "::warning::README status drift detected. Apply readme-status-sync.patch in a pull request."
          {
            echo "### README status drift detected"
            echo
            echo "Artifact `readme-status-sync.patch` contains the proposed update."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload sync patch
        if: steps.drift.outputs.has_drift == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: readme-status-sync.patch
          path: readme-status-sync.patch
